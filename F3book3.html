<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book</title>
  <style>
  body {
  font-family: Arial, sans-serif;
  background-color: #fffbe7;
  padding: 20px;
  line-height: 1.6;
}

.story-container {
  max-width: 600px;
  margin: auto;
  text-align: center;
}

.book-title {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 10px;
}

.book-img {
  width: 100%;
  max-height: 300px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 15px;
}

.clickable-word {
  cursor: pointer;
  border-bottom: 1px dotted #888;
  color: inherit;
}

.clickable-word:hover {
  background-color: #ffefc1;
}

.popup {
  position: absolute; 
  background-color: white;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  z-index: 999;
  max-width: 220px;
  display: none;
}

.popup-close {
  text-align: right;
  font-weight: bold;
  cursor: pointer;
  color: red;
  margin-bottom: 5px;
}

.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 16px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 9999;
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}


.toast.show {
  animation: slideDown 0.5s ease;
  opacity: 1;
  pointer-events: auto;
}

@keyframes slideDown {
  from {
    transform: translateX(-50%) translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}
</style>
</head>
<body>

<div class="story-container">
  <div class="book-title"></div>
<br>
  <p id="story-text-1">
<p id="story-text-1"></p>

<p id="story-text-2"></p>

<p id="story-text-3"></p>

<p id="story-text-4"></p>

<p id="story-text-5"></p>

<p id="story-text-6"></p>

<p id="story-text-7"></p>

<p id="story-text-8"></p>

<p id="story-text-9"></p>

<p id="story-text-10"></p>

<p id="story-text-11"></p>

<p id="story-text-12"></p>

<p id="story-text-13"></p>

<p id="story-text-14"></p>

<p id="story-text-15"></p>

<p id="story-text-16"></p>

<p id="story-text-17"></p>

<p id="story-text-18"></p>

<p id="story-text-19"></p>

<p id="story-text-20"></p>

<p id="story-text-21"></p>

<p id="story-text-22"></p>

<p id="story-text-23"></p>

<p id="story-text-24"></p>

<p id="story-text-25"></p>

<p id="story-text-26"></p>

<p id="story-text-27"></p>

<p id="story-text-28"></p>

<p id="story-text-29"></p>

<p id="story-text-30"></p>

<p id="story-text-31"></p>

<p id="story-text-32"></p>

<p id="story-text-33"></p>

<p id="story-text-34"></p>

<p id="story-text-35"></p>

<p id="story-text-36"></p>

<p id="story-text-37"></p>

<p id="story-text-38"></p>

<p id="story-text-39"></p>

<p id="story-text-40"></p>

<p id="story-text-41"></p>

<p id="story-text-42"></p>

<p id="story-text-43"></p>

<p id="story-text-44"></p>

<p id="story-text-45"></p>

<p id="story-text-46"></p>

<p id="story-text-47"></p>

<p id="story-text-48"></p>

<p id="story-text-49"></p>

<p id="story-text-50"></p>

<p id="story-text-51"></p>

<p id="story-text-52"></p>

<p id="story-text-53"></p>

<p id="story-text-54"></p>

<p id="story-text-55"></p>

<p id="story-text-56"></p>

<p id="story-text-57"></p>

<p id="story-text-58"></p>

<p id="story-text-59"></p>

<p id="story-text-60"></p>

<p id="story-text-61"></p>

<p id="story-text-62"></p>

<p id="story-text-63"></p>

<p id="story-text-64"></p>
<p id="story-text-65"></p>
<p id="story-text-66"></p>
<p id="story-text-67"></p>
<p id="story-text-68"></p>
<p id="story-text-69"></p>
<p id="story-text-70"></p>
<p id="story-text-71"></p>
<p id="story-text-72"></p>
<p id="story-text-73"></p>
<p id="story-text-74"></p>
<p id="story-text-75"></p>
<p id="story-text-76"></p>
<p id="story-text-77"></p>
<p id="story-text-78"></p>
<p id="story-text-79"></p>
<p id="story-text-80"></p>
<p id="story-text-81"></p>
<p id="story-text-82"></p>
<p id="story-text-83"></p>
<p id="story-text-84"></p>
<p id="story-text-85"></p>
<p id="story-text-86"></p>
<p id="story-text-87"></p>
<p id="story-text-88"></p>
<p id="story-text-89"></p>
<p id="story-text-90"></p>
<p id="story-text-91"></p>
<p id="story-text-92"></p>
<p id="story-text-93"></p>
<p id="story-text-94"></p>
<p id="story-text-95"></p>
<p id="story-text-96"></p>
<p id="story-text-97"></p>
<p id="story-text-98"></p>
<p id="story-text-99"></p>
<p id="story-text-100"></p>
</p>
</div>

<div id="toast" class="toast">Book recorded</div>

<div id="popup" class="popup" style="display: none;">
  <div class="popup-close" onclick="closePopup()">Ã—</div>
  <div id="popup-text">Loading...</div>
</div>

<script>
  const title = "Deadstar";
  const image = "deadstar.jpeg";
  const start = Date.now();
  const activeUser = localStorage.getItem("activeUser");
  let users = JSON.parse(localStorage.getItem("users") || "{}");

  document.addEventListener("DOMContentLoaded", () => {
    for (let i = 1; i <= 100; i++) {
      const storyEl = document.getElementById(`story-text-${i}`);
      if (!storyEl) continue;

      const originalText = storyEl.innerText;

      function makeWordsClickable(text) {
        return text.split(/(\s+)/).map(word => {
          if (word.trim() === "") return word;
          const clean = word.replace(/[.,!?":;()]/g, "");
          return `<span class="clickable-word" data-word="${clean}">${word}</span>`;
        }).join("");
      }

      storyEl.innerHTML = makeWordsClickable(originalText);
    }

    document.querySelectorAll(".clickable-word").forEach(word => {
      word.addEventListener("click", async (e) => {
        const rawWord = e.target.dataset.word.toLowerCase();
        const popup = document.getElementById("popup");
        const popupText = document.getElementById("popup-text");

        popupText.textContent = `Searching "${rawWord}"...`;
        popup.style.display = "block";

        const popupWidth = popup.offsetWidth;
        const pageX = e.pageX;
        const pageY = e.pageY - 60;

        if (pageX + popupWidth > window.innerWidth) {
          popup.style.left = `${window.innerWidth - popupWidth - 10}px`;
        } else {
          popup.style.left = `${pageX}px`;
        }

        if (window.innerWidth < 400) {
          popup.style.left = "10px";
          popup.style.right = "10px";
        }

        popup.style.top = `${pageY}px`;

        try {
          const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${rawWord}`);
          const data = await res.json();

          if (Array.isArray(data)) {
            const meaning = data[0]?.meanings[0]?.definitions[0]?.definition;
            popupText.textContent = `"${rawWord}" means: ${meaning}`;
          } else {
            popupText.textContent = `No definition found for "${rawWord}".`;
          }
        } catch (error) {
          popupText.textContent = `Error getting meaning.`;
        }
      });
    });

    document.addEventListener("click", (e) => {
      const popup = document.getElementById("popup");
      if (!popup.contains(e.target) && !e.target.classList.contains("clickable-word")) {
        popup.style.display = "none";
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.getElementById("popup").style.display = "none";
      }
    });
  });

  setTimeout(() => {
    const timeSpent = Date.now() - start;

    if (timeSpent >= 20000 && activeUser && users[activeUser]) {
      const userData = users[activeUser];
      userData.booksRead = userData.booksRead || [];

      const alreadyExists = userData.booksRead.some(book => book.title === title);
      if (!alreadyExists) {
        userData.booksRead.push({ title, image: image });
        users[activeUser] = userData;
        localStorage.setItem("users", JSON.stringify(users));

        const toast = document.getElementById("toast");
        toast.style.display = "block";
        toast.style.opacity = "1";

        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => {
            toast.style.display = "none";
            toast.style.opacity = "1";
          }, 1000);
        }, 3000);
      }
    }
  }, 20000);

  window.addEventListener("beforeunload", () => {
    const end = Date.now();
    const readingTime = end - start;

    if (activeUser && users[activeUser]) {
      users[activeUser].totalReadingTime = (users[activeUser].totalReadingTime || 0) + readingTime;
      localStorage.setItem("users", JSON.stringify(users));
    }
  });

  function closePopup() {
    document.getElementById("popup").style.display = "none";
  }
</script>

</body>
</html>